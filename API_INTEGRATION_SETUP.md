# ğŸ”Œ API Integration Setup Guide

## âœ… What's Been Configured

### 1. **Dependencies Added**

```json
{
  "dependencies": {
    "@tanstack/react-query": "^5.62.14",
    "axios": "^1.7.9"
  },
  "devDependencies": {
    "@tanstack/react-query-devtools": "^5.62.14",
    "orval": "^7.3.0"
  }
}
```

### 2. **Scripts Added**

```json
{
  "scripts": {
    "api:gen": "orval --config orval.config.ts",
    "api:gen:watch": "orval --config orval.config.ts --watch"
  }
}
```

### 3. **Files Created**

- âœ… `orval.config.ts` - Orval configuration
- âœ… `src/api/axios-instance.ts` - Axios with interceptors
- âœ… `src/providers/QueryProvider.tsx` - React Query provider

---

## ğŸš€ Installation Steps

### Step 1: Install Dependencies

```bash
npm install
```

### Step 2: Create Environment File

Create `.env` in project root:

```env
VITE_API_URL=https://meetings-quality-api.onrender.com/api
```

For local development:
```env
VITE_API_URL=http://localhost:3000/api
```

### Step 3: Generate API Client

**Important:** Your backend needs to expose OpenAPI/Swagger documentation.

```bash
npm run api:gen
```

This will:
- Fetch OpenAPI spec from your backend
- Generate TypeScript types
- Generate React Query hooks
- Create API client in `src/api/generated/`

**If your backend doesn't have OpenAPI docs yet:**
- You'll need to add Swagger/OpenAPI to your backend
- Or manually create API hooks (see Manual Setup below)

---

## ğŸ“ Project Structure

```
src/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ axios-instance.ts      âœ¨ Axios config with interceptors
â”‚   â””â”€â”€ generated/              âœ¨ Auto-generated by Orval
â”‚       â”œâ”€â”€ auth.ts             (API hooks for auth)
â”‚       â”œâ”€â”€ meetings.ts         (API hooks for meetings)
â”‚       â”œâ”€â”€ tasks.ts            (API hooks for tasks)
â”‚       â””â”€â”€ model/              (TypeScript types)
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ QueryProvider.tsx       âœ¨ React Query provider
â””â”€â”€ ...
```

---

## ğŸ”§ Update App.tsx

Wrap your app with QueryProvider:

```tsx
import { QueryProvider } from './src/providers/QueryProvider';

const App: React.FC = () => {
  return (
    <QueryProvider>
      <BrowserRouter basename="/meetings-quality">
        {/* Your routes */}
      </BrowserRouter>
    </QueryProvider>
  );
};
```

---

## ğŸ“– Usage Examples

### Example 1: Fetch Meetings

```tsx
import { useGetMeetings } from './api/generated/meetings';

function MeetingsList() {
  const { data, isLoading, error } = useGetMeetings();
  
  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  
  return (
    <div>
      {data?.map(meeting => (
        <div key={meeting.id}>{meeting.title}</div>
      ))}
    </div>
  );
}
```

### Example 2: Create Meeting

```tsx
import { useCreateMeeting } from './api/generated/meetings';

function CreateMeetingForm() {
  const { mutate, isPending } = useCreateMeeting();
  
  const handleSubmit = (data) => {
    mutate(data, {
      onSuccess: () => {
        console.log('Meeting created!');
      },
      onError: (error) => {
        console.error('Failed:', error);
      }
    });
  };
  
  return (
    <form onSubmit={handleSubmit}>
      {/* form fields */}
      <button disabled={isPending}>
        {isPending ? 'Creating...' : 'Create'}
      </button>
    </form>
  );
}
```

### Example 3: Login

```tsx
import { useLogin } from './api/generated/auth';

function LoginForm() {
  const { mutate, isPending } = useLogin();
  
  const handleLogin = (email, password) => {
    mutate(
      { email, password },
      {
        onSuccess: (data) => {
          // Save token
          localStorage.setItem('auth_token', data.token);
          // Redirect
          navigate('/dashboard');
        },
        onError: (error) => {
          alert('Login failed');
        }
      }
    );
  };
  
  return (
    <form onSubmit={handleLogin}>
      {/* form fields */}
    </form>
  );
}
```

---

## ğŸ”‘ Authentication Flow

### 1. Login Request
```tsx
const { mutate } = useLogin();
mutate({ email, password });
```

### 2. Save Token
```tsx
onSuccess: (data) => {
  localStorage.setItem('auth_token', data.token);
}
```

### 3. Axios Interceptor Adds Token
```tsx
// Automatically added to all requests
axios.interceptors.request.use((config) => {
  const token = localStorage.getItem('auth_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

### 4. Handle 401 Errors
```tsx
// Automatically redirects to login
axios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      localStorage.removeItem('auth_token');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

---

## ğŸ¯ Orval Configuration

### Current Config (`orval.config.ts`)

```typescript
export default defineConfig({
  api: {
    input: {
      target: 'https://meetings-quality-api.onrender.com/api/docs/json',
    },
    output: {
      mode: 'tags-split',
      target: './src/api/generated',
      client: 'react-query',
      baseUrl: 'https://meetings-quality-api.onrender.com/api',
    },
  },
});
```

### If Your Backend Uses Different OpenAPI Path

Update `input.target`:
- Swagger: `/api/swagger.json`
- OpenAPI: `/api/openapi.json`
- Docs: `/api/docs`
- Local file: `./openapi.json`

---

## ğŸ”„ Manual Setup (If No OpenAPI)

If your backend doesn't have OpenAPI docs, create hooks manually:

### Create `src/api/hooks/useMeetings.ts`

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { axios } from '../axios-instance';

// Fetch meetings
export const useGetMeetings = () => {
  return useQuery({
    queryKey: ['meetings'],
    queryFn: async () => {
      const { data } = await axios.get('/meetings');
      return data;
    },
  });
};

// Create meeting
export const useCreateMeeting = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (meetingData) => {
      const { data } = await axios.post('/meetings', meetingData);
      return data;
    },
    onSuccess: () => {
      // Invalidate and refetch
      queryClient.invalidateQueries({ queryKey: ['meetings'] });
    },
  });
};

// Update meeting
export const useUpdateMeeting = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async ({ id, ...data }) => {
      const response = await axios.patch(`/meetings/${id}`, data);
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['meetings'] });
    },
  });
};

// Delete meeting
export const useDeleteMeeting = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (id: string) => {
      await axios.delete(`/meetings/${id}`);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['meetings'] });
    },
  });
};
```

---

## ğŸ› ï¸ Commands Reference

```bash
# Install dependencies
npm install

# Generate API client from OpenAPI
npm run api:gen

# Generate and watch for changes
npm run api:gen:watch

# Run development server
npm run dev

# Build for production
npm run build

# Deploy to GitHub Pages
npm run deploy
```

---

## ğŸ› Troubleshooting

### Issue 1: Orval Can't Find OpenAPI Spec

**Error:** `Cannot fetch OpenAPI spec`

**Solutions:**
1. Check if your backend exposes OpenAPI/Swagger docs
2. Try different endpoints:
   - `/api/docs/json`
   - `/api/swagger.json`
   - `/api/openapi.json`
3. Download OpenAPI spec manually and use local file:
   ```typescript
   input: {
     target: './openapi.json'
   }
   ```

### Issue 2: CORS Errors

**Error:** `Access-Control-Allow-Origin`

**Solution:** Your backend needs to allow your frontend origin:
```javascript
// Backend CORS config
app.use(cors({
  origin: ['https://pluswhale.github.io', 'http://localhost:3000'],
  credentials: true
}));
```

### Issue 3: 401 Unauthorized

**Solutions:**
1. Check if token is saved: `localStorage.getItem('auth_token')`
2. Check token format: Should be `Bearer <token>`
3. Check token expiration
4. Re-login to get new token

### Issue 4: Types Not Generated

**Solutions:**
1. Ensure OpenAPI spec is valid
2. Check `orval.config.ts` paths
3. Run `npm run api:gen` manually
4. Check console for errors

---

## ğŸ“Š React Query DevTools

In development, you'll see React Query DevTools in bottom-right corner.

**Features:**
- ğŸ” View all queries and their states
- ğŸ”„ Manually refetch queries
- ğŸ—‘ï¸ Clear cache
- â±ï¸ See query timings
- ğŸ“Š Monitor network requests

**Toggle:** Click the React Query icon in bottom-right

---

## ğŸ¯ Migration from localStorage

### Before (localStorage):
```typescript
const meetings = useStore(state => state.meetings);
const createMeeting = useStore(state => state.createMeeting);
```

### After (API):
```typescript
const { data: meetings } = useGetMeetings();
const { mutate: createMeeting } = useCreateMeeting();
```

### Key Differences:
- âœ… Data synced across devices
- âœ… Automatic caching
- âœ… Loading states
- âœ… Error handling
- âœ… Optimistic updates
- âœ… Automatic refetching

---

## ğŸš€ Next Steps

1. **Install dependencies:**
   ```bash
   npm install
   ```

2. **Create `.env` file:**
   ```env
   VITE_API_URL=https://meetings-quality-api.onrender.com/api
   ```

3. **Generate API client:**
   ```bash
   npm run api:gen
   ```

4. **Update App.tsx:**
   - Add QueryProvider wrapper

5. **Start replacing localStorage:**
   - Replace `useStore` with API hooks
   - Add loading states
   - Add error handling

6. **Test everything:**
   - Login/Register
   - Create/Read/Update/Delete operations
   - Error scenarios

7. **Deploy:**
   ```bash
   npm run deploy
   ```

---

## ğŸ“š Resources

- [React Query Docs](https://tanstack.com/query/latest/docs/react/overview)
- [Orval Documentation](https://orval.dev/)
- [Axios Documentation](https://axios-http.com/docs/intro)

---

**Your API integration is ready! ğŸ‰**

Run `npm install` and `npm run api:gen` to get started!
